# Cấu hình mô phỏng
set val(chan) Channel/WirelessChannel    ;# Loại kênh truyền
set val(prop) Propagation/TwoRayGround   ;# Mô hình truyền sóng
set val(ant) Antenna/OmniAntenna         ;# Loại ăng-ten
set val(ll) LL                           ;# Loại lớp liên kết
set val(ifq) Queue/DropTail/PriQueue     ;# Loại hàng đợi
set val(ifqlen) 50                       ;# Kích thước tối đa của hàng đợi
set val(netif) Phy/WirelessPhy          ;# Loại giao diện mạng
set val(mac) Mac/802_11                 ;# Loại giao thức MAC
set val(nn) 50                          ;# Số lượng nút
set val(rp) AODV                        ;# Giao thức định tuyến
set val(x) 10000
set val(y) 10000
set ns [new Simulator]                  ;# Khởi tạo bộ mô phỏng

# Mở tệp trace và tệp NAM
set tracefd [open aodv50.tr w]
set namtrace [open aodv50.nam w]
$ns use-newtrace
$ns trace-all $tracefd
$ns namtrace-all-wireless $namtrace $val(x) $val(y)

# Tạo bản đồ mạng
set topo [new Topography]
$topo load_flatgrid $val(x) $val(y)
create-god $val(nn)

# Khởi tạo kênh
set chan_1 [new $val(chan)]

# Cấu hình nút
$ns node-config -adhocRouting $val(rp) \
-llType $val(ll) \
-macType $val(mac) \
-ifqType $val(ifq) \
-ifqLen $val(ifqlen) \
-antType $val(ant) \
-propType $val(prop) \
-phyType $val(netif) \
-topoInstance $topo \
-agentTrace OFF \
-routerTrace ON \
-macTrace ON \
-movementTrace OFF \
-channel $chan_1

# Hàm kết thúc mô phỏng
proc finish {} {
    global ns tracefd namtrace
    $ns flush-trace
    close $tracefd
    close $namtrace
    exec nam -r 5m aodv50.nam &   ;# Mở NAM
    exit 0
}

# Hàm ghi nhận kết quả
proc record {} {
    global ns sink9 f0 f1
    set time 0.05
    set bw0 [$sink9 set npkts_]
    set bw1 [$sink9 set nlost_]
    set now [$ns now]
    puts $f0 "$now [expr $bw0]"
    puts $f1 "$now [expr $bw1]"
    $ns at [expr $now + $time] "record"
}

# Tạo nút di động và cấu hình chuyển động
for {set i 0} {$i < $val(nn)} {incr i} {
    set n_($i) [$ns node]
    # Di chuyển các nút đến tọa độ xác định với tốc độ 10m/s
    $n_($i) setdest [expr $i % 7 * 1040 + 20] [expr $i % 3 * 3000 + 20] 10.0
}

# Tạo các agent (CBR, TCP, LossMonitor) và kết nối chúng
for {set i 0} {$i < $val(nn)} {incr i} {
    # Tạo Agent TCP cho nút 0 và các nút khác
    set tcp_($i) [new Agent/TCP]
    $ns attach-agent $n_($i) $tcp_($i)

    # Tạo Agent LossMonitor cho mỗi nút
    set sink_($i) [new Agent/LossMonitor]
    $ns attach-agent $n_($i) $sink_($i)

    # Tạo kết nối CBR giữa các nút
    if {$i == 0} {
        set cbr_0 [new Agent/CBR]
        $ns attach-agent $n_($i) $cbr_0
        $cbr_0 set packetSize_ 512
        $cbr_0 set interval_ 0.25
        $ns connect $cbr_0 $sink_($val(nn)-1)
        $ns at 0.0 "$cbr_0 start"
        $ns at 30.0 "$cbr_0 stop"
    }
}

# Hàm để khởi tạo lưu lượng TCP
proc start-tcp-traffic {} {
    global ns tcp_0 sink_0
    $ns at 1.0 "$tcp_0 start"
    $ns at 30.0 "$tcp_0 stop"
    $ns at 30.0 "finish"
}

# Kết thúc và chạy mô phỏng
puts "Start of simulation.."
$ns run
