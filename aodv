# Thiết lập thông số cơ bản cho mạng không dây
set val(chan) Channel/WirelessChannel    ;# Loại kênh (Wireless Channel)
set val(prop) Propagation/TwoRayGround  ;# Mô hình truyền sóng (TwoRayGround)
set val(netif) Phy/WirelessPhy          ;# Loại giao diện mạng (Wireless Physical Layer)
set val(mac) Mac/802_11                 ;# Giao thức MAC (802.11)

# Cấu hình hàng đợi
set val(ifq) Queue/DropTail/PriQueue    ;# Loại hàng đợi (DropTail với ưu tiên)
set val(ll) LL                          ;# Lớp liên kết (Link Layer)
set val(ant) Antenna/OmniAntenna        ;# Mô hình ăng-ten (Ăng-ten đa hướng)
set val(ifqlen) 50                      ;# Số gói tối đa trong hàng đợi giao diện
set val(nn) 30                          ;# Số node di động trong mạng
set val(rp) AODV                        ;# Giao thức định tuyến (AODV)
set val(x) 600                          ;# Kích thước trục X của mạng (600m)
set val(y) 500                          ;# Kích thước trục Y của mạng (500m)
set val(stop) 900                       ;# Thời gian mô phỏng kết thúc (900 giây)

# Thiết lập tập tin tải và cấu hình
set val(cp) "cbr30.tcl"                 ;# Tệp tin cấu hình tải
set val(sc) "node30.tcl"                ;# Tệp tin cấu hình kịch bản

# Khởi tạo mô phỏng
set ns_ [new Simulator]

# Tạo và ghi vào tệp .nam (visualization)
set namfile "simulation_output.nam"    ;# Tên tệp .nam
$ns_ namtrace-all $namfile             ;# Tạo tệp nam và ghi vào đó

# Tạo tệp .tr (trace file) để ghi lại các sự kiện mô phỏng
set tracefd [open traceaodv30.tr w]    ;# Tạo tệp traceaodv30.tr
$ns_ trace-all $tracefd                ;# Ghi tất cả các sự kiện vào tệp trace

# Tạo topography cho mạng
set topo [new Topography]
$topo load_flatgrid $val(x) $val(y)   ;# Tạo topo với kích thước đã chỉ định

# Tạo God (Global Positioning) để theo dõi các node
set god_ [create-god $val(nn)]         ;# Tạo God cho mô phỏng

# Cấu hình các node
$ns_ node-config -adhocRouting $val(rp) \
                 -llType $val(ll) \
                 -macType $val(mac) \
                 -ifqType $val(ifq) \
                 -ifqLen $val(ifqlen) \
                 -antType $val(ant) \
                 -propType $val(prop) \
                 -phyType $val(netif) \
                 -channelType $val(chan) \
                 -topoInstance $topo \
                 -agentTrace ON \
                 -routerTrace ON \
                 -macTrace ON \
                 -movementTrace ON

# Tạo các node và gán chúng vào God
for {set i 0} {$i < $val(nn)} {incr i} {
    set node_($i) [$ns_ node]
    $god_ new_node $node_($i)
}

# Nạp các tệp cấu hình tải và kịch bản
source $val(cp)
source $val(sc)

# Đặt sự kiện để reset các node tại thời điểm mô phỏng kết thúc
for {set i 0} {$i < $val(nn)} {incr i} {
    $ns_ at $val(stop) "$node_($i) reset"
}

# Đặt sự kiện để gọi thủ tục 'stop' tại thời điểm mô phỏng dừng
$ns_ at $val(stop) "stop"

# Đặt sự kiện hiển thị thông báo và dừng mô phỏng hoàn toàn
$ns_ at [expr $val(stop) + 0.01] "puts \"end simulation\" ; $ns_ halt"

# Định nghĩa thủ tục 'stop' để xử lý việc dừng mô phỏng và lưu trữ dữ liệu
proc stop {} {
    global ns_ tracefd  ;# Biến toàn cục để sử dụng đối tượng mô phỏng và tệp lưu vết
    $ns_ flush-trace    ;# Ghi tất cả dữ liệu còn trong bộ đệm vào tệp lưu vết
    close $tracefd      ;# Đóng tệp lưu vết
}

# Chạy mô phỏng
$ns_ run
