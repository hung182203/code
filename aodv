# Cấu hình mô phỏng
set val(chan) Channel/WirelessChannel    ;# Loại kênh truyền
set val(prop) Propagation/TwoRayGround   ;# Mô hình truyền sóng
set val(ant) Antenna/OmniAntenna         ;# Loại ăng-ten
set val(ll) LL                           ;# Loại lớp liên kết
set val(ifq) Queue/DropTail/PriQueue     ;# Loại hàng đợi
set val(ifqlen) 50                       ;# Kích thước tối đa của hàng đợi
set val(netif) Phy/WirelessPhy          ;# Loại giao diện mạng
set val(mac) Mac/802_11                 ;# Loại giao thức MAC
set val(nn) 50                          ;# Số lượng nút
set val(rp) AODV                        ;# Giao thức định tuyến
set val(x) 10000
set val(y) 10000
set ns [new Simulator]                  ;# Khởi tạo bộ mô phỏng

# Mở tệp trace và tệp NAM
set tracefd [open aodv50.tr w]
set namtrace [open aodv50.nam w]
$ns use-newtrace
$ns trace-all $tracefd
$ns namtrace-all-wireless $namtrace $val(x) $val(y)

# Tạo bản đồ mạng
set topo [new Topography]
$topo load_flatgrid $val(x) $val(y)
create-god $val(nn)

# Khởi tạo kênh
set chan_1 [new $val(chan)]

# Cấu hình nút
$ns node-config -adhocRouting $val(rp) \
-llType $val(ll) \
-macType $val(mac) \
-ifqType $val(ifq) \
-ifqLen $val(ifqlen) \
-antType $val(ant) \
-propType $val(prop) \
-phyType $val(netif) \
-topoInstance $topo \
-agentTrace OFF \
-routerTrace ON \
-macTrace ON \
-movementTrace OFF \
-channel $chan_1

# Hàm kết thúc mô phỏng
proc finish {} {
    global ns tracefd namtrace
    $ns flush-trace
    close $tracefd
    close $namtrace
    exec nam -r 5m aodv50.nam &   ;# Mở NAM
    exit 0
}

# Hàm ghi nhận kết quả
proc record {} {
    global ns sink9 f0 f1
    set time 0.05
    set bw0 [$sink9 set npkts_]
    set bw1 [$sink9 set nlost_]
    set now [$ns now]
    puts $f0 "$now [expr $bw0]"
    puts $f1 "$now [expr $bw1]"
    $ns at [expr $now + $time] "record"
}

# Tạo nút di động và cấu hình chuyển động
for {set i 0} {$i < $val(nn)} {incr i} {
    set n_($i) [$ns node]
    $n_($i) setdest [expr $i % 7 * 1040 + 20] [expr $i % 3 * 3000 + 20] 10.0
}

# Cấu hình lưu lượng CBR và kết nối TCP
proc attach-CBR-traffic {node sink size interval} {
    set ns [Simulator instance]
    set cbr [new Agent/CBR]
    $ns attach-agent $node $cbr
    $cbr set packetSize_ $size
    $cbr set interval_ $interval
    $ns connect $cbr $sink
    return $cbr
}

# Tạo lưu lượng CBR giữa các nút
set cbr0 [attach-CBR-traffic $n_(0) $sink_([expr $val(nn)-1]) 512 0.25]
set cbr1 [attach-CBR-traffic $n_(3) $sink_([expr $val(nn)-2]) 512 0.25]
$ns at 0.0 "$cbr0 start"
$ns at 30.0 "$cbr0 stop"
$ns at 30.0 "finish"

# Chạy mô phỏng
puts "Start of simulation.."
$ns run
