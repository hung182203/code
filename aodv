# Simulation Parameters
Mac/802_11 set dataRate_ 11Mb
set val(chan) Channel/WirelessChannel
set val(prop) Propagation/TwoRayGround
set val(ant) Antenna/OmniAntenna
set val(ll) LL
set val(ifq) Queue/DropTail/PriQueue
set val(ifqlen) 50
set val(netif) Phy/WirelessPhy
set val(mac) Mac/802_11
set val(nn) 50
set val(rp) AODV
set val(x) 1000
set val(y) 1000

set ns [new Simulator]

# Output files
set tracefd [open aodv50.tr w]
set namtrace [open aodv50.nam w]

$ns trace-all $tracefd
$ns namtrace-all-wireless $namtrace $val(x) $val(y)

# Topology configuration
set topo [new Topography]
$topo load_flatgrid $val(x) $val(y)

create-god $val(nn)
set chan_1 [new $val(chan)]

# Node configuration
$ns node-config -adhocRouting $val(rp) \
    -llType $val(ll) \
    -macType $val(mac) \
    -ifqType $val(ifq) \
    -ifqLen $val(ifqlen) \
    -antType $val(ant) \
    -propType $val(prop) \
    -phyType $val(netif) \
    -topoInstance $topo \
    -agentTrace OFF \
    -routerTrace ON \
    -macTrace ON \
    -channel $chan_1

# Create nodes
for {set i 0} {$i < $val(nn)} {incr i} {
    set n_($i) [$ns node]
    $n_($i) random-motion 0
}

# Arrange nodes in a grid
set grid_size 100
for {set i 0} {$i < $val(nn)} {incr i} {
    set row [expr $i / 10]
    set col [expr $i % 10]
    set x [expr $col * $grid_size + 50]
    set y [expr $row * $grid_size + 50]
    $n_($i) set X_ $x
    $n_($i) set Y_ $y
    $n_($i) set Z_ 0.0
}

# Mobility configuration
for {set i 0} {$i < $val(nn)} {incr i} {
    setdest [$n_($i)] [expr ($i + 1) * 50 % $val(x)] [expr ($i + 1) * 30 % $val(y)] 10.0
}

# Attach Traffic
proc attach-CBR-traffic {node sink size interval} {
    set ns [Simulator instance]
    set cbr [new Agent/CBR]
    $ns attach-agent $node $cbr
    $cbr set packetSize_ $size
    $cbr set interval_ $interval
    $ns connect $cbr $sink
    return $cbr
}

set sink_([expr $val(nn) - 1]) [new Agent/LossMonitor]
$ns attach-agent $n_([expr $val(nn) - 1]) $sink_([expr $val(nn) - 1])

set cbr0 [attach-CBR-traffic $n_(0) $sink_([expr $val(nn) - 1]) 512 0.25]

# Finish procedure
proc finish {} {
    global ns tracefd namtrace
    $ns flush-trace
    close $tracefd
    close $namtrace
    exec nam aodv50.nam &
    exit 0
}

# Schedule events
$ns at 0.0 "$cbr0 start"
$ns at 30.0 "$cbr0 stop"
$ns at 30.0 "finish"

# Run simulation
puts "Starting simulation..."
$ns run
